<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="../css/bootstrap.min.css">
        <style>body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>
        <link rel="stylesheet" href="../css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="../css/main.css">

        <script src="../js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="../index.html">ITP DWD SPRING 2013</a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li class="active"><a href="../index.html">Home</a></li>
                            <!-- <li><a href="#about">About</a></li>
                            <li><a href="#contact">Contact</a></li>-->
                            <li class="dropdown">
                                <a href="week-5.html#" class="dropdown-toggle" data-toggle="dropdown">Notes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="../page/cheatsheet.html">DWD Cheatsheet</a>
                                    </li>
                                  <li>
                                    <a href="week-1.html">
                                    Week 1 - Introduction to web development
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-2.html">
                                    Week 2 - JavaScript functions, events &amp; callbacks
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-3.html">
                                    Week 3 - Getting started with NodeJS &amp; Heroku
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-4.html">
                                    Week 4 - ExpressJS framework &amp; templates
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-5.html">
                                    Week 5 - Databases and MongoDB
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-6.html">
                                    Week 6 - More on Databases
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-7.html">
                                    Week 7 - Database review and form validation
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-8.html">
                                    Week 8 -  Introduction to API&#39;s &amp; JSON
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-9.html">
                                    Week 9 - Remote APIs, JSON and AJAX
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-10.html">
                                    Week 10 - Sessions and Cookies
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-11.html">
                                    Week 11 - Uploading files / Amazon S3
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-12.html">
                                    Week 12 - Websockets and real-time communication
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-13.html">
                                    Week 13 - Arduinos, Processing and JSON 
                                    </a>
                                  </li>
                                  <li>
                                    <a href="week-14.html">
                                    Week 14 - Final Presentations
                                    </a>
                                  </li>
                               <!--      <li><a href="#">Action</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li class="divider"></li>
                                    <li class="nav-header">Nav header</li>
                                    <li><a href="#">Separated link</a></li>
                                    <li><a href="#">One more separated link</a></li> -->
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="week-5.html#" class="dropdown-toggle" data-toggle="dropdown">Previous Classes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a href="http://itppyweb.herokuapp.com">Fall 2012 - Python</a>
                                    </li>
                                    <li>
                                        <a href="http://itpwebclassspring2012.herokuapp.com">Spring 2012 - NodeJS</a>
                                    </li>
                                </ul>
                            </li>
                            
                        </ul>
                        <form class="hide navbar-form pull-right">
                            <input class="span2" type="text" placeholder="Email">
                            <input class="span2" type="password" placeholder="Password">
                            <button type="submit" class="btn">Sign in</button>
                        </form>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <div class="container">

            <div class="row">

    <div class="span2">
        <div class="well">
            <a href="week-5.html#notes">Notes</a><br>
            <a href="week-5.html#assignment">Assignment</a>
        </div>
    </div>

    <div class="span10">
        <article>
            <header>
                <h1>Week 5 - Databases and MongoDB</h1>
            
            </header>
            
            <div class="intro">
                <p>Database - long term memory. Discuss data modelling, saving and retrieving data. Getting started with MongoDB on Heroku with AddOns.</p>
            </div>

            <hr>
            
            <section id="notes">
                <h3>
<a href="https://github.com/johnschimmel/Heroku-ExpressJS-Boilerplate">Github Code</a><br>
<a href="http://itpdwdexpresstemplates.herokuapp.com/">http://itpdwdexpresstemplates.herokuapp.com/</a>
</h3>
<hr>
<h2 id="databases">Databases</h2>

<p>Databases allow you to create, retrieve, update and delete data (CRUD). Commonly web applications use a database to display content submitted by the site editors or collect information from users via a form.</p>

<p>Database come in a few flavors </p>

<h3 id="getting-started-with-mongodb-on-heroku">Getting started with MongoDB on Heroku</h3>

<p>We will be using MongoLabs as our MongoDB host service, they have a free starter plan that we can easily associate with our Heroku accounts. When we have added the MongoLabs service we will have a connection string that includes username, password and URI to the database server.</p>

<h4 id="step-1-adding-mongolabs-to-your-heroku-app">Step 1 : Adding MongoLabs to your Heroku App</h4>

<ul>
<li>Verify your Heroku account to start using the Add-on services, http://www.heroku.com/verify.</li>
<li><p>Navigate to the code folder in Terminal and run the following command.</p>

<pre><code>heroku addons:add mongolab:starter
</code></pre></li>
</ul>

<h4 id="step-2-get-the-mongolabs-uri-to-your-database">Step 2: Get the MongoLabs URI to your database</h4>

<ul>
<li>Next, we need to get the username, password and database URI that MongoLabs has supplied us. Heroku keeps this in the a configuration file. </li>
</ul>

<p>Get your Monglab URI, run the following command in Terminal</p>

<pre><code>heroku config --shell | grep MONGOLAB_URI &gt;&gt; .env
</code></pre>

<p>See all Heroku config variable</p>

<pre><code>heroku config
</code></pre>

<h4 id="step-3-verify-environment-configuration-file-env">Step 3: Verify environment configuration file (.env)</h4>

<p>The .env file will store the MongoLabs URI which includes your username and password. The contents of .env will be available in your code as environment variables.</p>

<pre><code>MONGOLAB_URI=mongodb://username:password@host:port/database
</code></pre>

<p>If your file looks different, try the steps above again. Save the .env file after updated.</p>

<p>You can access environment variables in your NodeJS code, for example in web.js as follows,</p>

<pre><code>process.env.MONGOLAB_URI 
// this is the same as manually coding 'mongodb://username:password@host:port/database'
</code></pre>

<h4 id="step-4-verify-contents-gitignore-file">Step 4: Verify contents .gitignore file</h4>

<p>If the .gitignore file does not exist, create it. Place the following text inside and save.</p>

<pre><code>node_modules
.env
</code></pre>

<hr />

<h3 id="include-mongo-modules-in-packagejson">Include Mongo Modules in Package.json</h3>

<p>We will use <strong>MongooseJS</strong> to connect and query our MongoLab database. Let's add to MongooseJS to our package.json</p>

<p><strong>package.json (dependencies section)</strong></p>

<pre><code>...
"dependencies": {
    "express": "3.0.0rc5",
    "hogan-express" : "0.3.3",
    "moment" : "1.7.2",
    "mongoose" : "3.5.4"
},
...
</code></pre>

<p>Install new modules with</p>

<pre><code>npm install
</code></pre>

<h3 id="connect-appjs-to-database">Connect app.js to database</h3>

<p>Require Mongoose at the top of your app.js file</p>

<pre><code>var mongoose = require('mongoose');
</code></pre>

<p>Inside the app.configure callback function, add or uncomment the line </p>

<pre><code>app.db = mongoose.connect(process.env.MONGOLAB_URI);
</code></pre>

<p>app.db will use Mongoose to connect to the MongoLab URI inside our .env file</p>

<p>NOTE: process.env is declared and initialized by foreman. That's why we use <strong>foreman start</strong> or an alternative of <strong>foreman</strong> to start our applications.</p>

<h3 id="define-your-data-schema">Define your data schema</h3>

<p><a href="http://docs.mongodb.org/manual/core/document/">MongoDB Documents</a></p>

<p>MongoDB stores data in documents. The data is shape is defined with Schemas using Mongoose. All Mongo documents store in BSON format, which is very similar for to JSON for most purposes.</p>

<p><a href="http://mongoosejs.com/docs/guide.html">Mongoose Guide</a></p>

<p>The Mongoose guide is the best place to start to understand how to set up and query your data.</p>

<h4 id="schemas-and-models-">Schemas and Models -</h4>

<p>Schemas define what shape your data will take, very much like a JavaScript object Mongoose Schema allows you to define fields and their data types, strings, booleans, arrays, dates, etc.</p>

<p>There is a new file called /models/astronaut.js, this includes the data definitions or schema for your database. You will define what data you will be saving in your Mongo collection. See the Mongoose web site for more information, <a href="http://mongoosejs.com/">http://mongoosejs.com/</a></p>

<p><strong>models/astronaut.js</strong></p>

<pre><code>var mongoose = require('mongoose');
var Schema = mongoose.Schema;

// define a new schema
var AstronautSchema = new Schema({
    slug : { type: String, lowercase: true, unique: true },
    name : String,
    birthdate : Date,
    missions : [String],
    photo : String,
    source : {
        name : String,
        url : String
    },
    skills : [String],
    walkedOnMoon : Boolean,

    lastupdated : { type: Date, default: Date.now }
});

// export 'Astronaut' model
module.exports = mongoose.model('Astronaut',AstronautSchema);
</code></pre>

<p>Models are the <strong>constructor</strong> of a Schema. Models are used to create, retrieve, update and delete data.</p>

<h4 id="inserting-new-data">Inserting new data</h4>

<p>Mongoose Docs <a href="http://mongoosejs.com/docs/models.html">http://mongoosejs.com/docs/models.html</a></p>

<p>Create a new astronaut document from the astronaut model.</p>

<pre><code>var astronautModel = require('../models/astronaut.js');
var astroData = {
    name : 'John Schimmel',
    skills : ['floating','repairing satellites'],
    walkedOnMoon : false
};
var newAstro = new astronautModel(astroData); // new astronaut document
newAstro.save(); //save to database
</code></pre>

<h4 id="querying-data">Querying data</h4>

<p>Retrieve your data, <a href="http://mongoosejs.com/docs/queries.html">http://mongoosejs.com/docs/queries.html</a></p>

<pre><code>var astronautModel = require('../models/astronaut.js');

var filter = {}; // no filter
var fields = 'name slug birthdate'

astronautModel.find(filter, fields, function(err, astronauts){
    if (err) {
        console.error('uhoh something went wrong');
        console.error(err);
    }
    if (astronauts == null) {
        console.log("no astronauts found");
    } else {
        console.log("found " + astronauts.length + " astronauts");

        for(a in astronauts) {
            var currAstro = astronauts[a]; // current looped astronaut
            console.log(currAstro.name + " " + currAstro.birthdate);
        }
    }
})
</code></pre>

<h4 id="query-for-a-specific-piece-of-data">Query for a specific piece of data</h4>

<pre><code>var astronautModel = require('../models/astronaut.js');

var filter = {slug:'john_glenn'}; // filter where slug==john_glenn
astronautModel.findOne(filter, function(err, astronaut){
    if (err) {
        console.error('uhoh something went wrong');
        console.error(err);
    }
    if (astronaut == null) {
        console.log("Could not find your astronaut");
    } else {
        console.log("found your astronaut");
        console.log(astronaut);
    }
})
</code></pre>

<h4 id="open-your-mongolab-admin-panel">Open your MongoLab Admin Panel</h4>

<pre><code>heroku addons:open mongolab:starter
</code></pre>
            </section>
            <br>
            <hr>
            <br>
            <section id="assigment">
                <a name="assignment"></a>
<h1>Assignment</h1>

<p>This is a very important week. The rest of the semester builds on our web applications having database access, 
<li>this week get your Heroku app connected to MongoLab</li>
<li>create a Schema for your data inside the /models/yourschema.js file</li>
<li>Insert some data using a form POSt</li>
<li>Query and display data</li>
</p>

            </section>

            <section id="comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'itpdwdspring2013';

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
            </section>


        </article>
        
    </div>

    
</div>

        </div> <!-- /container -->

        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.9.0.min.js"><\/script>')</script>

        <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.2/bootstrap.min.js"></script>

        <script src="../js/main.js"></script>

        <script>
            var _gaq=[['_setAccount','UA-29253415-1'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>
